<% extend('../partials/template_admin') %>

<!-- table -->
<% if(all_users.length > 0) { %>
<div class="table_box">
    <table id="user_table" class="tables">
        <thead>
            <tr>
                <th>Handling</th>
                <th>Navn</th>
                <th>Fornavn</th>
                <th>Efternavn</th>
                <th>Adresse</th>
                <th>By</th>
                <th>Postnr</th>
                <th>Billede</th>
                <th>Email</th>
                <th>Rank</th>
                <th>Oprettet</th>
            </tr>
        </thead>
        <tbody>
            <% (all_users || []).forEach(user =>{ %>
            <tr>
                <td>
                    <a href="/admin/bruger/ret/<%= user.user_id %>">Ret</a>
                    <a href="/admin/bruger/slet/<%= user.user_id %>" onclick="return confirm('Er du sikker?')">Slet</a>
                </td>

                <td><%= user.user_name %></td>

                <td><%= user.user_firstname %></td>

                <td><%= user.user_lastname %></td>

                <td><%= user.user_address %></td>

                <td><%= user.user_city %></td>

                <td><%= user.user_areacode %></td>

                <td>
                    <img width="50" src="/images/users/resized/<%= user.user_image %>" alt="user Thumb">
                </td>

                <td><%= user.user_email %></td>

                <td><%= user.user_rank %></td>

                <td><%= user.user_created %></td>
            </tr>
            <% }) %>
        </tbody>

        <tfoot>
            <tr>
                <td colspan="11">oversigt over brugere</td>
            </tr>
        </tfoot>
    </table>
</div>
<% } %>

<div class="form_box">
    <h3 id="form_type"><%= formtype %></h3>
    <form id="register_form" class="forms" enctype="multipart/form-data" method="POST">
        <div class="choiches">
            <!-- brugernavn -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_name">Brugernavn</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_name" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.name : '') %>
                        </span>
    
                        <span id="match_error" class="error_msg">
                            <%= match_error %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_name" id="user_name"
                        value="<%= (typeof one_user != 'undefined' ? one_user.user_name: '') %>"
                        placeholder="Indtast Brugernavn">
                </div>
            </div>
    
            <!-- fornavn -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_firstname">Fornavn</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_firstname" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.firstname : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_firstname" id="user_firstname" value="<%= (typeof one_user != 'undefined' ? one_user.user_firstname: '') %>" placeholder="Indtast Fornavn">
                </div>
            </div>
    
            <!-- efternavn -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_lastname">Efternavn</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_lastname" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.lastname : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_lastname" id="user_lastname" value="<%= (typeof one_user != 'undefined' ? one_user.user_lastname: '') %>" placeholder="Indtast Efternavn">
                </div>
            </div>
    
            <!-- adresse -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_address">Adresse</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_address" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.address : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_address" id="user_address" value="<%= (typeof one_user != 'undefined' ? one_user.user_address: '') %>" placeholder="Indtast Adresse">
                </div>
            </div>
    
            <!-- by -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_city">By</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_city" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.city : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_city" id="user_city" value="<%= (typeof one_user != 'undefined' ? one_user.user_city: '') %>" placeholder="Indtast By">
                </div>
            </div>
    
            <!-- postnummer -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_areacode">Postnummer</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_areacode" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.areacode : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="number" name="user_areacode" id="user_areacode" value="<%= (typeof one_user != 'undefined' ? one_user.user_areacode: '') %>" placeholder="Indtast Postnummer">
                </div>
            </div>
    
            <!-- email -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_email">Email</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_email" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.email : '') %>
                        </span>
    
                        <span id="match_error" class="error_msg">
                            <%= match_error %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="text" name="user_email" id="user_email"
                        value="<%= (typeof one_user != 'undefined' ? one_user.user_email: '') %>" placeholder="Indtast Email">
                </div>
            </div>
    
            <!-- kodeord -->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_password">Kodeord</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_password" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.password : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="password" name="user_password" id="user_password"
                        value="<%= (typeof one_user != 'undefined' ? one_user.user_password: '') %>"
                        placeholder="Indtast Kodeord">
                </div>
            </div>
    
            <!-- gentagKodeord -->
            <!-- Må ikke nangives repeat da det allerede er en indbygget funktionerne, der henter values fra fejl og 
            input felter, skære ordet i stykker. og selv hvis man kalder den user_repeat_password skær den af 
            user_repeat_ af så der kun er password tilbgage (Brug CAMELCASE)-->
            <div class="form_choiche">
                <div class="form_text">
                    <div class="form_title">
                        <label for="user_repeatPassword">Gentag</label>
                    </div>
    
                    <div class="form_error">
                        <span id="err_repeatPassword" class="error_msg">
                            <%= (typeof error_msg != 'undefined' ? error_msg.repeatPassword : '') %>
                        </span>
                    </div>
                </div>
    
                <div class="form_field">
                    <input type="password" name="user_repeatPassword" id="user_repeatPassword" value=""
                        placeholder="Gentag Kodeord">
                </div>
            </div>
        </div> <!-- Choiches End -->
    
        <!-- rolle niveau -->
        <div class="form_outer_choiche">
            <div class="form_text">
                <div class="form_title">
                    <label for="user_rank">Rolle Niveau</label>
                </div>
    
                <div class="form_error">
                    <span id="err_rank" class="error_msg">
                        <%= (typeof error_msg != 'undefined' ? error_msg.rank : '') %>
                    </span>
                </div>
            </div>
    
            <div class="form_field">
                <select name="user_rank" id="user_rank">
                    <option value="0">
                        Vælg rolle
                    </option>
    
                    <option value="10" <%=(typeof one_user !='undefined' && one_user.user_rank==10 ? 'selected' : '' ) %>>
                        Bruger
                    </option>
    
                    <option value="100" <%=(typeof one_user !='undefined' && one_user.user_rank==100 ? 'selected' : '' ) %>>
                        Administrator
                    </option>
                </select>
            </div>
        </div>
    
        <!-- Billede -->
        <div class="form_outer_choiche">
            <div class="form_title">
                <label for="user_image">Profil Billede</label>
            </div>
    
            <input type="file" name="user_image">
    
            <!-- Gammelt billede -->
            <div>
                <img src="/images/users/<%= (formtype == "opret" ? "no-image.png" : one_user.user_image) %>" alt="Profil billede">
                <input type="hidden" name="user_old_img" value="<%= one_user.user_image %>">
            </div>
        </div>
    
        <!-- knapper -->
        <div class="form_actions">
            <button type="submit" class="btn linear_gr"><%= formtype %></button>
            <a href="/admin/brugere" class="link_basic">Annuler</a>
        </div>
    </form>
</div> <!-- Form Box End -->

<script>
    document.querySelector('#register_form button').addEventListener('click', (event) => {
        event.preventDefault();
        // ryd alle eksisterende fejleskeder 
        let error_messages = document.querySelectorAll('.error_msg');
        error_messages.forEach(function (error_msg) {
            error_msg.textContent = '';
        });

        // Form
        let form = document.querySelector('#register_form');
        // form.submit();

        // hent alle værdierne fra formular felterne 
        let values = {};
        for (let i = 0; i < form.length; i++) {
            // '.name.split('_')[1]' benyttes til at fjerne 'user_' fra hvert et felt
            if (form[i].name.split('_')[1] != undefined) {
                values[form[i].name.split('_')[1]] = form[i].value;
            }
        }
        // Opret tomt json objekt til fejlbeskeder
        let error_msg = {};

        // Validering af værdier oprettelse af fejlbeskeds nøgler
        if (values.name == undefined || values.name == "") {
            error_msg.name = "Udfyld Brugernavn (Client Side)";
        }

        if (values.firstname == undefined || values.firstname == "") {
            error_msg.firstname = "Udfyld Fornavn (Client Side)";
        }

        if (values.lastname == undefined || values.lastname == "") {
            error_msg.lastname = "Udfyld Efternavn (Client Side)";
        }
        
        if (values.address == undefined || values.address == "") {
            error_msg.address = "Udfyld Adresse (Client Side)";
        }  
        
        if (values.city == undefined || values.city == "") {
            error_msg.city = "Udfyld By (Client Side)";
        }
        
        if (isNaN(values.areacode) || values.areacode == undefined || values.areacode == '') {
            error_msg.areacode = "Udfyld Postnummer (Client Side)";
        }   

        if (values.email == undefined || values.email == "") {
            error_msg.email = "Udfyld email (Client Side)";
        } else if (!validateEmail(values.email)) {
            error_msg.email = "ikke en gyldig email (Client Side)";
        }

        if (document.querySelector("#form_type").textContent == "Opret") {
            if (values.password == undefined || values.password == '') {
                error_msg.password = "Udfyld Kodeord (Client Side)";
            }
            if (values.repeatPassword == undefined || values.repeatPassword == "") {
                error_msg.repeatPassword = "Gentag Kodeord (Client Side)";
            }

            if (values.repeatPassword != '' && values.password !== values.repeatPassword) {
                error_msg.repeatPassword = "Kodeord Matcher ikke (Client Side)";
            }
        }

        if (values.rank == undefined || isNaN(values.rank) || values.rank == 0) {
            error_msg.rank = "Vælg rolle niveau (Client Side)";
        }

        // hvis der er 1 eller flere fejl, skal der udskrives fejl eller sendes form 
        if (Object.keys(error_msg).length > 0) {
            Object.keys(error_msg).forEach(function (key) {
                // key feltet der indeholder en fejl for at finde span tagget der hvor '#err_' skal fjernes
                document.querySelector(`#err_${key}`).textContent = error_msg[key];
            });
        }
        else {
            form.submit();
        }
    })
</script>